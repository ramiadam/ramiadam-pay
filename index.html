<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Moyasar Apple Pay Test Harness</title>

  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/moyasar-payment-form@2.2.6/dist/moyasar.css" />
  <script src="https://cdn.jsdelivr.net/npm/moyasar-payment-form@2.2.6/dist/moyasar.umd.min.js"></script>

  <style>
    body { margin:0; font-family:system-ui; background:#0f172a; color:#e5e7eb; }
    .wrap { max-width:1100px; margin:0 auto; padding:20px; }
    .grid { display:grid; grid-template-columns:420px 1fr; gap:16px; }
    @media(max-width:900px){ .grid{ grid-template-columns:1fr; } }

    .card { background:#111827; border:1px solid #1f2937;
      border-radius:16px; padding:16px; }

    h2 { font-size:14px; margin-bottom:10px; color:#9ca3af; }
    label { font-size:12px; color:#9ca3af; display:block; margin-bottom:6px; }
    input, select { width:100%; padding:8px;
      background:#0b1220; color:#fff; border:1px solid #1f2937;
      border-radius:10px; }

    .row { display:flex; gap:10px; flex-wrap:wrap; }
    .toggle { display:flex; align-items:center; gap:8px;
      padding:8px; border:1px solid #1f2937;
      border-radius:12px; background:#0b1220; }

    button { padding:8px 12px; border-radius:10px;
      border:1px solid #1f2937; background:#1f2937;
      color:#fff; cursor:pointer; }

    pre { background:#0b1220; padding:12px;
      border-radius:12px; overflow:auto; }

    .pill { padding:5px 10px; border-radius:999px;
      font-size:12px; border:1px solid #1f2937; }
  </style>
</head>

<body>
<div class="wrap">
<h1>Apple Pay Test Harness</h1>

<div class="grid">

<!-- CONFIG PANEL -->
<div class="card">
<h2>Configuration</h2>

<label>Publishable Key</label>
<input id="pk" placeholder="pk_live_..." />

<label>Amount (halalas)</label>
<input id="amount" type="number" value="1000" />

<label>Description</label>
<input id="desc" value="Apple Pay Test" />

<div class="row" style="margin-top:10px;">
  <label class="toggle">
    <input id="mApple" type="checkbox" checked />
    Apple Pay
  </label>
  <label class="toggle">
    <input id="mCard" type="checkbox" checked />
    Credit Card
  </label>
</div>

<div class="row" style="margin-top:10px;">
  <label class="toggle">
    <input id="manual" type="checkbox" checked />
    Manual (Authorize only)
  </label>
  <label class="toggle">
    <input id="saveCard" type="checkbox" checked />
    Save Card (Tokenize)
  </label>
</div>

<h2 style="margin-top:20px;">Networks</h2>
<div class="row">
  <label class="toggle"><input class="net" type="checkbox" value="mada" checked /> mada</label>
  <label class="toggle"><input class="net" type="checkbox" value="visa" checked /> visa</label>
  <label class="toggle"><input class="net" type="checkbox" value="mastercard" checked /> mastercard</label>
  <label class="toggle"><input class="net" type="checkbox" value="amex" checked /> amex</label>
</div>

<h2 style="margin-top:20px;">Metadata</h2>
<label>Key 1</label>
<input id="md1k" value="scenario" />
<label>Value 1</label>
<input id="md1v" value="applepay_test" />
<label>Key 2</label>
<input id="md2k" value="tester" />
<label>Value 2</label>
<input id="md2v" value="rami" />

<div style="margin-top:16px;">
<button id="apply">Apply & Re-init</button>
<button id="clear">Clear Saved</button>
</div>
</div>

<!-- RUNNER -->
<div class="card">
<h2>Status</h2>
<div class="row">
<span class="pill" id="apAvail">ApplePaySession: ?</span>
<span class="pill" id="lastId">Last ID: —</span>
<span class="pill" id="lastToken">Token: —</span>
</div>

<h2 style="margin-top:20px;">Form</h2>
<div id="formMount"></div>

<h2 style="margin-top:20px;">Payment Response</h2>
<pre id="result">Waiting…</pre>
</div>

</div>
</div>

<script>
const K = {
  pid:"moyasar_last_payment_id",
  tok:"moyasar_last_token",
  src:"moyasar_last_source"
};

const $ = id => document.getElementById(id);
const formMount = $("formMount");
const result = $("result");

function updateStatus() {
  $("apAvail").textContent =
    "ApplePaySession: " + (typeof ApplePaySession !== "undefined");

  $("lastId").textContent =
    "Last ID: " + (localStorage.getItem(K.pid) || "—");

  $("lastToken").textContent =
    "Token: " + (localStorage.getItem(K.tok) || "—");
}

function getNetworks() {
  return [...document.querySelectorAll(".net")]
    .filter(x=>x.checked)
    .map(x=>x.value);
}

function buildMetadata(){
  const m = {};
  if($("md1k").value) m[$("md1k").value] = $("md1v").value;
  if($("md2k").value) m[$("md2k").value] = $("md2v").value;
  return m;
}

async function initForm() {
  formMount.innerHTML = "";
  result.textContent = "Waiting…";

  Moyasar.init({
    element:"#formMount",
    amount: parseInt($("amount").value,10),
    currency:"SAR",
    description:$("desc").value,
    publishable_api_key:$("pk").value,
    methods:[
      $("mApple").checked && "applepay",
      $("mCard").checked && "creditcard"
    ].filter(Boolean),

    manual:$("manual").checked,
    supported_networks:getNetworks(),

    apple_pay:{
      country:"SA",
      label:"Rami",
      validate_merchant_url:"https://api.moyasar.com/v1/applepay/initiate",
      manual:$("manual").checked,
      save_card:$("saveCard").checked
    },

    metadata:buildMetadata(),

    on_completed: async function(payment){
      result.textContent = JSON.stringify(payment,null,2);

      if(payment?.id)
        localStorage.setItem(K.pid,payment.id);

      const token = payment?.source?.token;
      if(token)
        localStorage.setItem(K.tok,token);
      else
        localStorage.removeItem(K.tok);

      localStorage.setItem(K.src,
        JSON.stringify(payment?.source||null));

      updateStatus();
      return payment;
    },

    on_failure: async function(error){
      result.textContent =
        "FAILED:\n" + JSON.stringify(error,null,2);
      return error;
    }
  });

  updateStatus();
}

$("apply").addEventListener("click",initForm);
$("clear").addEventListener("click",()=>{
  localStorage.clear();
  updateStatus();
  result.textContent="Cleared.";
});

updateStatus();
initForm();
</script>

</body>
</html>
