<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Moyasar Apple Pay Test (2.2.6)</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/moyasar-payment-form@2.2.6/dist/moyasar.css" />
    <script src="https://cdn.jsdelivr.net/npm/moyasar-payment-form@2.2.6/dist/moyasar.umd.min.js"></script>

    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; padding: 24px; }
      .wrap { max-width: 640px; margin: 0 auto; }
      pre { background: #f6f8fa; padding: 12px; border-radius: 10px; overflow:auto; }
      .box { margin-top: 12px; padding: 12px; border-radius: 10px; background: #f6f8fa; }
      code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
      button { padding: 8px 12px; border-radius: 10px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
      button:active { transform: translateY(1px); }
    </style>
  </head>

  <body>
    <div class="wrap">
      <h1>Moyasar Apple Pay Test</h1>

      <div class="box">
        <button id="resetBtn" type="button">Reset + Re-init</button>
        <button id="clearBtn" type="button">Clear saved</button>
        <div style="margin-top:10px;">
          <b>Last payment id:</b> <span id="pid"><i>None</i></span><br/>
          <b>Token:</b> <span id="token"><i>None</i></span>
        </div>
      </div>

      <h3>Form</h3>
      <div id="formMount"></div>

      <h3>Log</h3>
      <pre id="log">Ready.</pre>
    </div>

    <script>
      const PUBLISHABLE_KEY = "pk_live_x7yDncyvViCw8yG3VpwMT7DhpdSWqUnTiWTdyjr8";
      const callbackUrl = new URL("thanks.html", window.location.href).toString();

      const logEl = document.getElementById("log");
      const pidEl = document.getElementById("pid");
      const tokenEl = document.getElementById("token");
      const formMount = document.getElementById("formMount");

      function log(msg, obj) {
        logEl.textContent += "\n" + msg + (obj ? "\n" + JSON.stringify(obj, null, 2) : "");
      }
      function showSaved() {
        const pid = localStorage.getItem("moyasar_last_payment_id");
        const tok = localStorage.getItem("moyasar_last_token");
        pidEl.innerHTML = pid ? `<code>${pid}</code>` : "<i>None</i>";
        tokenEl.innerHTML = tok ? `<code>${tok}</code>` : "<i>None</i>";
      }
      function clearSaved() {
        localStorage.removeItem("moyasar_last_payment_id");
        localStorage.removeItem("moyasar_last_token");
        localStorage.removeItem("moyasar_last_source");
        showSaved();
        logEl.textContent = "Cleared.";
      }

      async function init() {
        logEl.textContent = "Initializing…";

        if (!window.Moyasar) {
          logEl.textContent = "❌ Moyasar not loaded";
          return;
        }

        // Reset mount to avoid keeping old state in DOM
        formMount.innerHTML = "";

        Moyasar.init({
          element: "#formMount",
          amount: 5000, // 10.00 SAR
          currency: "SAR",
          description: "Apple Pay Test",
          publishable_api_key: PUBLISHABLE_KEY,
          callback_url: callbackUrl,

          // IMPORTANT: this removes UnionPay from Apple Pay request generation
          supported_networks: ["mada", "visa", "mastercard"],

          // show CC too so the form always renders (optional)
          methods: ["applepay", "creditcard"],

          manual: true,

          apple_pay: {
            country: "SA",
            label: "Rami",
            validate_merchant_url: "https://api.moyasar.com/v1/applepay/initiate",
            manual: true,
            save_card: true
          },

          // MPF 2.2.6 requires promise-based callbacks
          on_completed: async function (payment) {
            log("✅ on_completed", payment);

            if (payment?.id) localStorage.setItem("moyasar_last_payment_id", payment.id);

            const token = payment?.source?.token;
            if (token) localStorage.setItem("moyasar_last_token", token);
            else localStorage.removeItem("moyasar_last_token");

            localStorage.setItem("moyasar_last_source", JSON.stringify(payment?.source || null));

            showSaved();
            return payment;
          },

          on_failure: async function (error) {
            log("❌ on_failure", error);
            return error;
          }
        });

        logEl.textContent = "✅ Form rendered. Try Apple Pay again.";
      }

      document.getElementById("resetBtn").addEventListener("click", init);
      document.getElementById("clearBtn").addEventListener("click", clearSaved);

      showSaved();
      init();
    </script>
  </body>
</html>
