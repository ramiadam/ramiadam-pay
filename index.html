<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Moyasar Apple Pay Test Harness (MPF 2.2.6)</title>

    <!-- MPF 2.2.6 -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/moyasar-payment-form@2.2.6/dist/moyasar.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/moyasar-payment-form@2.2.6/dist/moyasar.umd.min.js"></script>

    <style>
      :root {
        --bg: #0b1220;
        --panel: #0f172a;
        --card: #0c1426;
        --line: rgba(148, 163, 184, 0.18);
        --text: #e5e7eb;
        --muted: rgba(229, 231, 235, 0.7);
        --chip: rgba(148, 163, 184, 0.12);
        --chipLine: rgba(148, 163, 184, 0.22);
        --good: rgba(34, 197, 94, 0.95);
        --warn: rgba(245, 158, 11, 0.95);
        --bad: rgba(239, 68, 68, 0.95);
      }

      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
        background: radial-gradient(1200px 600px at 20% 0%, rgba(56,189,248,.08), transparent 60%),
                    radial-gradient(1000px 600px at 90% 10%, rgba(99,102,241,.10), transparent 55%),
                    var(--bg);
        color: var(--text);
      }
      .wrap { max-width: 1100px; margin: 0 auto; padding: 22px; }
      h1 { font-size: 22px; margin: 0 0 6px; }
      .sub { color: var(--muted); font-size: 13px; margin: 0 0 16px; }

      .grid { display: grid; grid-template-columns: 420px 1fr; gap: 16px; align-items: start; }
      @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }

      .card {
        background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
        border: 1px solid var(--line);
        border-radius: 18px;
        padding: 14px;
        box-shadow: 0 12px 40px rgba(0,0,0,.25);
        backdrop-filter: blur(6px);
      }

      .card h2 {
        font-size: 14px;
        margin: 0 0 12px;
        color: rgba(229,231,235,.85);
        font-weight: 650;
        letter-spacing: .02em;
      }

      label { display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
      input[type="text"], input[type="number"], select {
        width: 100%;
        padding: 10px 10px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: rgba(2,6,23,.55);
        color: var(--text);
        outline: none;
      }

      .field { margin-bottom: 12px; }
      .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
      .toggle {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        padding: 10px;
        border-radius: 14px;
        border: 1px solid var(--line);
        background: rgba(2,6,23,.45);
        flex: 1;
        min-width: 180px;
      }
      .toggle input { margin-top: 2px; }
      .toggle b { font-size: 13px; }
      .toggle span { display:block; margin-top: 2px; font-size: 12px; color: var(--muted); }

      .chips { display:flex; flex-wrap: wrap; gap: 8px; }
      .chip {
        border: 1px solid var(--chipLine);
        background: var(--chip);
        color: rgba(229,231,235,.9);
        border-radius: 999px;
        padding: 6px 10px;
        font-size: 12px;
      }

      .btn {
        border: 1px solid var(--line);
        background: rgba(2,6,23,.55);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 12px;
        cursor: pointer;
      }
      .btn.primary { background: rgba(99,102,241,.20); border-color: rgba(99,102,241,.35); }
      .btn:active { transform: translateY(1px); }

      .hint { color: var(--muted); font-size: 12px; line-height: 1.35; }

      pre {
        margin: 0;
        border-radius: 18px;
        border: 1px solid var(--line);
        background: rgba(2,6,23,.65);
        padding: 12px;
        overflow: auto;
        min-height: 120px;
      }

      .status { display:flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 10px; }
      .pill {
        border: 1px solid var(--line);
        background: rgba(2,6,23,.55);
        border-radius: 999px;
        padding: 6px 10px;
        font-size: 12px;
        color: rgba(229,231,235,.9);
      }
      .pill.good { border-color: rgba(34,197,94,.35); color: rgba(134,239,172,.95); }
      .pill.warn { border-color: rgba(245,158,11,.35); color: rgba(253,230,138,.95); }
      .pill.bad { border-color: rgba(239,68,68,.35); color: rgba(252,165,165,.95); }

      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
      .divider { height: 1px; background: var(--line); margin: 10px 0; }
    </style>
  </head>

  <body>
    <div class="wrap">
      <h1>Moyasar Apple Pay Test Harness</h1>
      <p class="sub">Toggle config from the UI. MPF 2.2.6 (promise-based callbacks).</p>

      <div class="grid">
        <!-- Left: Config -->
        <div class="card">
          <h2>Configuration</h2>

          <div class="field">
            <label>Publishable Key</label>
            <input id="pk" type="text" placeholder="pk_live_..." />
            <div class="hint" style="margin-top:6px;">Stored locally in your browser (localStorage).</div>
          </div>

          <div class="row">
            <div class="field" style="flex:1; min-width: 160px;">
              <label>Amount (halalas)</label>
              <input id="amount" type="number" min="1" step="1" />
              <div class="hint" style="margin-top:6px;">1000 = 10.00 SAR</div>
            </div>
            <div class="field" style="flex:1; min-width: 140px;">
              <label>Currency</label>
              <select id="currency">
                <option value="SAR">SAR</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label>Description</label>
            <input id="desc" type="text" />
          </div>

          <div class="field">
            <label>Methods</label>
            <div class="row">
              <label class="toggle">
                <input id="mApplePay" type="checkbox" />
                <div>
                  <b>Apple Pay</b>
                  <span>method: applepay</span>
                </div>
              </label>

              <label class="toggle">
                <input id="mCard" type="checkbox" />
                <div>
                  <b>Credit Card</b>
                  <span>method: creditcard</span>
                </div>
              </label>
            </div>
            <div class="hint" style="margin-top:6px;">
              Keep creditcard enabled while debugging so you can confirm the widget renders.
            </div>
          </div>

          <div class="field">
            <label>Supported Networks</label>
            <div class="chips" id="netChips"></div>
            <div class="row" style="margin-top:10px;">
              <label class="toggle" style="min-width: 190px;">
                <input class="net" type="checkbox" value="mada" />
                <div><b>mada</b><span>recommended for KSA</span></div>
              </label>
              <label class="toggle" style="min-width: 190px;">
                <input class="net" type="checkbox" value="visa" />
                <div><b>visa</b><span>supported</span></div>
              </label>
            </div>
            <div class="row" style="margin-top:10px;">
              <label class="toggle" style="min-width: 190px;">
                <input class="net" type="checkbox" value="mastercard" />
                <div><b>mastercard</b><span>supported</span></div>
              </label>
              <label class="toggle" style="min-width: 190px;">
                <input class="net" type="checkbox" value="amex" />
                <div><b>amex</b><span>supported</span></div>
              </label>
            </div>
            <div class="hint" style="margin-top:6px;">
              We avoid <span class="mono">unionpay</span> (Safari error: “not a valid payment network”).
            </div>
          </div>

          <div class="field">
            <label>Apple Pay</label>
            <div class="row">
              <div style="flex:1; min-width: 140px;">
                <label>Country</label>
                <select id="apCountry">
                  <option value="SA">SA</option>
                </select>
              </div>
              <div style="flex:1; min-width: 160px;">
                <label>Label</label>
                <input id="apLabel" type="text" />
              </div>
            </div>

            <div class="row" style="margin-top:10px;">
              <label class="toggle">
                <input id="manual" type="checkbox" />
                <div><b>Manual</b><span>authorize only; capture later</span></div>
              </label>
              <label class="toggle">
                <input id="saveCard" type="checkbox" />
                <div><b>Save card</b><span>tokenize if enabled</span></div>
              </label>
            </div>

            <div class="hint" style="margin-top:10px;">
              validate_merchant_url is hardcoded to:
              <div class="mono" style="margin-top:6px;">https://api.moyasar.com/v1/applepay/initiate</div>
            </div>
          </div>

          <div class="field">
            <label>Metadata (2 fields)</label>
            <div class="row">
              <div style="flex:1; min-width: 160px;">
                <label>metadata[key1]</label>
                <input id="md1k" type="text" />
              </div>
              <div style="flex:1; min-width: 200px;">
                <label>metadata[value1]</label>
                <input id="md1v" type="text" />
              </div>
            </div>
            <div style="height:10px;"></div>
            <div class="row">
              <div style="flex:1; min-width: 160px;">
                <label>metadata[key2]</label>
                <input id="md2k" type="text" />
              </div>
              <div style="flex:1; min-width: 200px;">
                <label>metadata[value2]</label>
                <input id="md2v" type="text" />
              </div>
            </div>
          </div>

          <div class="row" style="margin-top: 12px;">
            <button class="btn primary" id="applyBtn" type="button">Apply + Re-init</button>
            <button class="btn" id="clearBtn" type="button">Clear Saved (token/id)</button>
          </div>

          <div class="hint" style="margin-top:10px;">
            The form is only initialized when config is valid (pk + methods + networks).
          </div>
        </div>

        <!-- Right: Runner -->
        <div class="card">
          <h2>Runner</h2>

          <div class="status">
            <span class="pill" id="apAvail">ApplePaySession: ?</span>
            <span class="pill" id="canPay">canMakePayments(): ?</span>
            <span class="pill" id="lastPid">Last payment id: —</span>
            <span class="pill" id="lastTok">Token: —</span>
          </div>

          <div id="formMount"></div>

          <div class="divider"></div>

          <h2>Payment Object (on_completed)</h2>
          <pre id="result">Waiting…</pre>

          <div class="divider"></div>

          <h2>Saved Source (localStorage)</h2>
          <pre id="savedSource">—</pre>
        </div>
      </div>
    </div>

    <script>
      const STORE = {
        cfg: "moyasar_ui_cfg_v2",
        pid: "moyasar_last_payment_id",
        tok: "moyasar_last_token",
        src: "moyasar_last_source",
      };

      const HARD_VALIDATE_URL = "https://api.moyasar.com/v1/applepay/initiate";

      const $ = (id) => document.getElementById(id);
      const formMount = $("formMount");
      const resultEl = $("result");
      const savedSourceEl = $("savedSource");
      const apAvailEl = $("apAvail");
      const canPayEl = $("canPay");
      const lastPidEl = $("lastPid");
      const lastTokEl = $("lastTok");
      const netChips = $("netChips");

      const pk = $("pk");
      const amount = $("amount");
      const currency = $("currency");
      const desc = $("desc");

      const mApplePay = $("mApplePay");
      const mCard = $("mCard");

      const manual = $("manual");
      const saveCard = $("saveCard");

      const apCountry = $("apCountry");
      const apLabel = $("apLabel");

      const md1k = $("md1k");
      const md1v = $("md1v");
      const md2k = $("md2k");
      const md2v = $("md2v");

      const netBoxes = Array.from(document.querySelectorAll("input.net"));

      function safeParse(s, fallback) {
        try { return JSON.parse(s); } catch { return fallback; }
      }

      function setPill(el, text, kind = "") {
        el.classList.remove("good", "warn", "bad");
        if (kind) el.classList.add(kind);
        el.textContent = text;
      }

      function renderChips(networks) {
        netChips.innerHTML = "";
        networks.forEach((n) => {
          const d = document.createElement("div");
          d.className = "chip";
          d.textContent = n;
          netChips.appendChild(d);
        });
      }

      function lastSaved() {
        return {
          pid: localStorage.getItem(STORE.pid),
          tok: localStorage.getItem(STORE.tok),
          src: localStorage.getItem(STORE.src),
        };
      }

      function refreshSavedPanels() {
        const { pid, tok, src } = lastSaved();
        lastPidEl.textContent = "Last payment id: " + (pid || "—");
        lastTokEl.textContent = "Token: " + (tok || "—");
        savedSourceEl.textContent = src ? JSON.stringify(safeParse(src, src), null, 2) : "—";
      }

      function refreshApplePayAvailability() {
        const has = typeof window.ApplePaySession !== "undefined";
        setPill(apAvailEl, "ApplePaySession: " + has, has ? "good" : "warn");

        if (has && typeof ApplePaySession.canMakePayments === "function") {
          try {
            const can = ApplePaySession.canMakePayments();
            setPill(canPayEl, "canMakePayments(): " + can, can ? "good" : "warn");
          } catch {
            setPill(canPayEl, "canMakePayments(): error", "bad");
          }
        } else {
          setPill(canPayEl, "canMakePayments(): n/a", "warn");
        }
      }

      function buildMetadata() {
        const obj = {};
        const k1 = md1k.value.trim();
        const v1 = md1v.value.trim();
        const k2 = md2k.value.trim();
        const v2 = md2v.value.trim();
        if (k1) obj[k1] = v1;
        if (k2) obj[k2] = v2;
        return obj;
      }

      function collectConfig() {
        const methods = [];
        if (mApplePay.checked) methods.push("applepay");
        if (mCard.checked) methods.push("creditcard");

        const networks = netBoxes.filter(b => b.checked).map(b => b.value);

        return {
          publishable_key: pk.value.trim(),
          amount: Math.max(1, parseInt(amount.value || "1000", 10)),
          currency: currency.value,
          description: desc.value.trim() || "Apple Pay Test",
          methods,
          supported_networks: networks,
          manual: manual.checked,
          apple_pay: {
            country: apCountry.value,
            label: apLabel.value.trim() || "Rami",
            manual: manual.checked,
            save_card: saveCard.checked,
          },
          metadata: buildMetadata(),
        };
      }

      function applyToUI(cfg) {
        pk.value = cfg.publishable_key || "";
        amount.value = cfg.amount ?? 1000;
        currency.value = cfg.currency || "SAR";
        desc.value = cfg.description || "Apple Pay Test";

        mApplePay.checked = cfg.methods?.includes("applepay") ?? true;
        mCard.checked = cfg.methods?.includes("creditcard") ?? true;

        manual.checked = !!cfg.manual;
        saveCard.checked = !!cfg.apple_pay?.save_card;

        apCountry.value = cfg.apple_pay?.country || "SA";
        apLabel.value = cfg.apple_pay?.label || "Rami";

        const networks = cfg.supported_networks || ["mada","visa","mastercard","amex"];
        netBoxes.forEach(b => b.checked = networks.includes(b.value));
        renderChips(networks);

        const md = cfg.metadata || {};
        const keys = Object.keys(md);
        md1k.value = keys[0] || "scenario";
        md1v.value = keys[0] ? (md[keys[0]] ?? "") : "applepay_test";
        md2k.value = keys[1] || "tester";
        md2v.value = keys[1] ? (md[keys[1]] ?? "") : "rami";
      }

      function isValidConfig(cfg) {
        if (!cfg.publishable_key || !cfg.publishable_key.startsWith("pk_")) return { ok:false, msg:"Enter a valid publishable key (pk_...)." };
        if (!cfg.methods?.length) return { ok:false, msg:"Select at least one method (Apple Pay / Credit Card)." };
        if (!cfg.supported_networks?.length) return { ok:false, msg:"Select at least one supported network." };
        return { ok:true, msg:"" };
      }

      async function initForm(cfg) {
        resultEl.textContent = "Waiting…";
        formMount.innerHTML = ""; // destroy old MPF DOM

        refreshApplePayAvailability();
        refreshSavedPanels();

        if (!window.Moyasar) {
          resultEl.textContent = "❌ Moyasar not loaded. Check CDN/network.";
          return;
        }

        const v = isValidConfig(cfg);
        if (!v.ok) {
          resultEl.textContent = "⚠️ " + v.msg + "\n\nThen click Apply.";
          return;
        }

        // v2.2.6 requires promise-based callbacks
        Moyasar.init({
          element: "#formMount",
          amount: cfg.amount,
          currency: cfg.currency,
          description: cfg.description,
          publishable_api_key: cfg.publishable_key,
          callback_url: new URL("thanks.html", window.location.href).toString(),
          methods: cfg.methods,

          manual: cfg.manual,
          supported_networks: cfg.supported_networks,

          apple_pay: {
            country: cfg.apple_pay.country,
            label: cfg.apple_pay.label,
            validate_merchant_url: HARD_VALIDATE_URL, // ✅ hardcoded
            manual: cfg.apple_pay.manual,
            save_card: cfg.apple_pay.save_card,
          },

          metadata: cfg.metadata,

          on_completed: async function (payment) {
            resultEl.textContent = JSON.stringify(payment, null, 2);

            if (payment?.id) localStorage.setItem(STORE.pid, payment.id);

            const token = payment?.source?.token;
            if (token) localStorage.setItem(STORE.tok, token);
            else localStorage.removeItem(STORE.tok);

            localStorage.setItem(STORE.src, JSON.stringify(payment?.source || null));

            refreshSavedPanels();
            return payment;
          },

          on_failure: async function (error) {
            resultEl.textContent =
              "FAILED:\n" + (typeof error === "string" ? error : JSON.stringify(error, null, 2));
            return error;
          },
        });

        refreshSavedPanels();
      }

      $("applyBtn").addEventListener("click", async () => {
        const cfg = collectConfig();
        localStorage.setItem(STORE.cfg, JSON.stringify(cfg));
        renderChips(cfg.supported_networks);
        await initForm(cfg);
      });

      $("clearBtn").addEventListener("click", () => {
        localStorage.removeItem(STORE.pid);
        localStorage.removeItem(STORE.tok);
        localStorage.removeItem(STORE.src);
        refreshSavedPanels();
        resultEl.textContent = "Cleared saved payment id/token/source.";
      });

      netBoxes.forEach(b => b.addEventListener("change", () => {
        renderChips(netBoxes.filter(x => x.checked).map(x => x.value));
      }));

      (async () => {
        const saved = safeParse(localStorage.getItem(STORE.cfg), null) || {
          publishable_key: "",
          amount: 1000,
          currency: "SAR",
          description: "Apple Pay Test",
          methods: ["applepay", "creditcard"],
          supported_networks: ["mada", "visa", "mastercard", "amex"],
          manual: true,
          apple_pay: { country: "SA", label: "Rami", manual: true, save_card: true },
          metadata: { scenario: "applepay_test", tester: "rami" },
        };

        applyToUI(saved);
        refreshApplePayAvailability();
        refreshSavedPanels();

        // Don't auto-init unless key is valid; avoids MPF "Form configuration issue"
        const cfg = collectConfig();
        const v = isValidConfig(cfg);
        if (v.ok) await initForm(cfg);
        else resultEl.textContent = "⚠️ " + v.msg + "\n\nThen click Apply.";
      })();
    </script>
  </body>
</html>
