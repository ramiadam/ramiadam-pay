<script>
  const resultEl = document.getElementById("result");
  const tokenLineEl = document.getElementById("tokenLine");

  function log(msg, obj) {
    resultEl.textContent =
      (resultEl.textContent === "Waiting…" ? "" : resultEl.textContent + "\n") +
      msg +
      (obj ? "\n" + JSON.stringify(obj, null, 2) : "") +
      "\n";
  }

  // 1) Confirm Moyasar script loaded
  if (!window.Moyasar) {
    log("❌ Moyasar.js not loaded. Check Network tab / CDN blocked.");
    throw new Error("Moyasar not loaded");
  }
  log("✅ Moyasar.js loaded");

  // 2) Check if Apple Pay is available in this browser/device
  const hasApplePaySession = typeof window.ApplePaySession !== "undefined";
  log("ApplePaySession exists: " + hasApplePaySession);

  if (hasApplePaySession && typeof ApplePaySession.canMakePayments === "function") {
    try {
      log("canMakePayments(): " + ApplePaySession.canMakePayments());
    } catch (e) {
      log("⚠️ canMakePayments() threw error", { message: e.message });
    }
  }

  // show any previously saved token
  const existing = localStorage.getItem("moyasar_last_token");
  if (existing) tokenLineEl.innerHTML = "<code>" + existing + "</code>";

  const callbackUrl = new URL("thanks.html", window.location.href).toString();

  try {
    Moyasar.init({
      element: ".mysr-form",
      amount: 5000,
      currency: "SAR",
      description: "Apple Pay Test",
      publishable_api_key: "pk_live_x7yDncyvViCw8yG3VpwMT7DhpdSWqUnTiWTdyjr8",
      callback_url: callbackUrl,
      methods: ["applepay", "creditcard"],

      apple_pay: {
        country: "SA",
        label: "Rami",
        manual: true,
        save_card: true,
        validate_merchant_url: "https://api.moyasar.com/v1/applepay/initiate",
      },

      on_completed: function (payment) {
        log("✅ on_completed fired", payment);
        const token = payment?.source?.token;
        if (token) {
          localStorage.setItem("moyasar_last_token", token);
          tokenLineEl.innerHTML = "<code>" + token + "</code>";
        } else {
          log("⚠️ No token returned on payment.source.token");
        }
      },

      on_failure: function (error) {
        log("❌ on_failure fired", error);
      },
    });

    log("✅ Moyasar.init called. If Apple Pay is available, a button should appear above.");
  } catch (e) {
    log("❌ Moyasar.init crashed", { message: e.message, stack: e.stack });
  }
</script>
